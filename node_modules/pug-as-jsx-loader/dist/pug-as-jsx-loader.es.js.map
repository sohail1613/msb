{"version":3,"file":"pug-as-jsx-loader.es.js","sources":["../src/codemod.helper.js","../src/codemod.js","../src/index.js"],"sourcesContent":["const j = require('jscodeshift');\nconst babylon = require('@babel/parser');\n\nconst parser = {\n  parse(code) {\n    return babylon.parse(code, {\n      sourceType: 'module',\n      allowImportExportEverywhere: true,\n      allowReturnOutsideFunction: true,\n      startLine: 1,\n      tokens: true,\n      plugins: [\n        'jsx',\n        'asyncGenerators',\n        'bigInt',\n        'classPrivateMethods',\n        'classPrivateProperties',\n        'classProperties',\n        'decorators-legacy',\n        'doExpressions',\n        'dynamicImport',\n        'exportDefaultFrom',\n        'exportExtensions',\n        'exportNamespaceFrom',\n        'functionBind',\n        'functionSent',\n        'importMeta',\n        'nullishCoalescingOperator',\n        'numericSeparator',\n        'objectRestSpread',\n        'optionalCatchBinding',\n        'optionalChaining',\n        ['pipelineOperator', {\n          proposal: 'minimal'\n        }],\n        'throwExpressions',\n        'typescript'\n      ],\n    });\n  },\n};\n\nconst getSource = (source, file) => {\n  const fileExt = file.split('.').pop();\n  if (fileExt === 'ts' || fileExt === 'tsx') {\n    return j(source, {\n      parser,\n    });\n  }\n  return j(source);\n};\n\nexport { getSource };\n","/* eslint-disable no-param-reassign */\nimport j from 'jscodeshift';\nimport { getSource } from './codemod.helper';\n\nconst fs = require('fs');\nconst path = require('path');\nconst glob = require('glob');\n\n// templateFn.call(this, { ... })\nconst isTemplateWithThis = (p, templateFuncs) =>\n  p.node.callee.object && templateFuncs.indexOf(p.node.callee.object.name) !== -1 &&\n  p.node.callee.property && p.node.callee.property.name === 'call';\n\n// templateFn({ ... })\nconst isTemplateWithoutThis = (p, templateFuncs) =>\n  !p.node.callee.object && !p.node.callee.property &&\n  templateFuncs.indexOf(p.node.callee.name) !== -1;\n\nconst compareVariables = (a, b) => {\n  const nameA = a.key.name.replace(/^unused_/, '');\n  const nameB = b.key.name.replace(/^unused_/, '');\n  const priorityA = nameA.search(/^[A-Z]/) !== -1 ? 1 : 0;\n  const priorityB = nameB.search(/^[A-Z]/) !== -1 ? 1 : 0;\n  if (priorityA === priorityB) {\n    if (nameA === nameB) {\n      return 0;\n    }\n    return nameA > nameB ? 1 : -1;\n  }\n  return priorityA > priorityB ? 1 : -1;\n};\n\nconst getLinkedJsFiles = (files) => {\n  const linkedJsFiles = glob.sync(path.join(files.path, '*.{js,jsx,ts,tsx}'))\n    .filter(file => file.search('.pug.transpiled.jsx') === -1)\n    .map((file) => {\n      const content = fs.readFileSync(file, 'utf8');\n      const templateFuncs = getSource(content, file)\n        .find(j.ImportDeclaration)\n        .nodes()\n        .filter((e) => {\n          if (e.specifiers && e.specifiers.length === 1 &&\n            e.source.value.search('./') === 0 &&\n            path.join(files.path, e.source.value) === path.join(files.path, files.pug)\n          ) {\n            return true;\n          }\n          return false;\n        })\n        .map(e => e.specifiers[0].local.name);\n      return { file, content, templateFuncs };\n    })\n    .filter(e => e.templateFuncs.length > 0);\n  return linkedJsFiles;\n};\n\n\nconst codemod = ({ useThis, variables }, resourcePath) => {\n  try {\n    const filePath = resourcePath.split(path.sep).join('/');\n    const files = {\n      path: filePath.replace(/\\/[^/]+$/, ''),\n      pug: `./${filePath.replace(/\\.[a-zA-Z0-9]+$/, '').split('/').pop()}.pug`,\n    };\n\n    const printOptions = {\n      quote: 'single',\n      trailingComma: true,\n    };\n\n    const jsFiles = getLinkedJsFiles(files);\n\n    jsFiles.forEach(({ file, content, templateFuncs }) => {\n      let commentRemoved = content;\n      getSource(content, file)\n      .find(j.CallExpression)\n      .filter(ce =>\n        isTemplateWithThis(ce, templateFuncs) || isTemplateWithoutThis(ce, templateFuncs),\n      )\n      .forEach((ce) => {\n        const templateFuncName = ce.node.callee.object ?\n          ce.node.callee.object.name : ce.node.callee.name;\n\n        commentRemoved = commentRemoved.replace(new RegExp(`${templateFuncName}(.call)?\\\\([\\\\s\\\\S]+?}\\\\);`, 'g'), whole =>\n          whole.replace(/\\/\\/.*?\\n/g, '\\n'));\n      });\n\n      const breadcrumbs = {};\n\n      const root = getSource(commentRemoved, file)\n      .find(j.CallExpression)\n      .filter(ce =>\n        isTemplateWithThis(ce, templateFuncs) || isTemplateWithoutThis(ce, templateFuncs),\n      )\n      .forEach((ce) => {\n        const withThis = isTemplateWithThis(ce, templateFuncs);\n\n        const templateFuncName = ce.node.callee.object ?\n          ce.node.callee.object.name : ce.node.callee.name;\n\n        let variableExists = false;\n        let componentExists = false;\n        let properties = (((ce.node.arguments || [])[withThis ? 1 : 0] || {}).properties || [])\n          .map((p) => {\n            const pureName = p.key.name.replace(/^unused_/, '');\n            if (variables.indexOf(pureName) !== -1) {\n              p.key.name = pureName;\n            } else if (variables.indexOf(p.key.name) === -1) {\n              p.key.name = `unused_${pureName}`;\n            }\n            delete p.comments;\n            return p;\n          });\n\n        const oldVars = properties.map(p => p.key.name);\n\n        properties = [\n          ...properties,\n          ...variables\n            .filter(p => oldVars.indexOf(p) === -1)\n            .map(e => j.objectProperty(\n                j.identifier(e),\n                j.identifier(e),\n              )),\n        ]\n          .sort(compareVariables)\n          .map((p) => {\n            if (!variableExists && p.key.name.search(/^[A-Z]/) === -1) {\n              p.comments = [j.commentLine(' variables')];\n              variableExists = true;\n            }\n            if (!componentExists && p.key.name.search(/^[A-Z]/) !== -1) {\n              p.comments = [j.commentLine(' components')];\n              componentExists = true;\n            }\n            if (p.value.type === 'JSXElement') {\n              const jsxCode = j(p.value).toSource().trim();\n              // Wrap jsx code with parenthesis: keep\n              if (jsxCode.search(/^\\(/) === -1) {\n                const key = `jsx__${Math.random().toString(36).substr(-6)}`;\n                breadcrumbs[key] = jsxCode;\n                p.value = j.literal(key);\n              }\n            }\n            p.shorthand = p.key.name === p.value.name;\n            return p;\n          });\n        if (useThis) {\n          ce.node.callee = j.memberExpression(\n            j.identifier(templateFuncName),\n            j.identifier('call'),\n          );\n          ce.node.arguments = [\n            j.thisExpression(),\n            (properties.length > 0 ? j.objectExpression(properties) : null),\n          ].filter(e => e);\n        } else {\n          ce.node.callee = j.identifier(templateFuncName);\n          ce.node.arguments = [\n            (properties.length > 0 ? j.objectExpression(properties) : null),\n          ].filter(e => e);\n        }\n      });\n\n      // Wrap jsx code with parenthesis: write down\n      let result = Object.keys(breadcrumbs)\n      .reduce((prev, key) =>\n        prev.replace(new RegExp(`\\n(\\\\s+)(.*?):\\\\s+'${key}'`), (whole, p1, p2) =>\n          `\\n${p1}${p2}: (\\n${breadcrumbs[key].split('\\n').map(e => `${p1}  ${e}`).join('\\n')}\\n${p1})`)\n      , root.toSource(printOptions));\n\n      templateFuncs.forEach((templateFunc) => {\n        result = result.replace(new RegExp(`${templateFunc}(.call)?\\\\([\\\\s\\\\S]+?}\\\\);`, 'g'), whole =>\n        whole.replace(/\\n\\s*\\n/g, '\\n'));\n      });\n\n      if (result !== content) {\n        fs.writeFileSync(file, result, 'utf8');\n      }\n    });\n  } catch (err) {\n    console.error(err);\n  }\n};\n\nexport default codemod;\n","import { pugToJsx } from 'pug-as-jsx-utils';\nimport { getOptions } from 'loader-utils';\nimport codemod from './codemod';\n\nconst fs = require('fs');\nconst path = require('path');\n\nexport default function loader(source) {\n  const options = getOptions(this) || this;\n  const { transform, pragma, autoFix } = options || {};\n  const rootDir = (options || {}).rootDir || this.rootContext;\n  const { resourcePath } = this;\n  let resolve = {};\n  if (options.resolve) {\n    resolve = { ...options.resolve };\n  } else {\n    // for legacy props\n    if (options.resolveComponents) {\n      resolve = Object.entries(options.resolveComponents)\n        .reduce((prev, [name, moduleName]) => ({\n          ...prev,\n          [moduleName]: { name },\n        }), resolve);\n    }\n    if (options.resolveVariables) {\n      resolve = Object.entries(options.resolveVariables)\n        .reduce((prev, [name, moduleName]) => ({\n          ...prev,\n          [moduleName]: { name },\n        }), resolve);\n    }\n  }\n\n  // process pug in js\n  if (this.resourcePath.split('.').pop().search(/^js/) !== -1 || source.match(/\\s+pug`[\\s\\S]+`/)) {\n    let useMacro = false;\n    let jsxTemplate = source.replace(/(\\n)?(\\s*)?(.*)\\s+pug`([\\s\\S]+?)`/g, (whole, _p0, _p1, p2, p3) => {\n      const { jsx, useMacro: macroFound } = pugToJsx(p3, {\n        template: true,\n        resolve,\n        transform,\n        pragma,\n        autoFix,\n        rootDir,\n        resourcePath,\n      });\n      if (macroFound) {\n        useMacro = true;\n      }\n      const p0 = _p0 || '';\n      const p1 = _p1 || '';\n      const code = jsx.split(/\\n/).map(e => ' '.repeat(p1.length + 2) + e).join('\\n');\n      return `${p0}${p1}${p2} (\\n${code}\\n${p1})`;\n    });\n    if (useMacro) {\n      jsxTemplate = `import __macro from 'pug-as-jsx-loader/lib/macro';\\n\\n${jsxTemplate}`;\n    }\n    return options.detail ? { jsxTemplate, variables: [] } : jsxTemplate;\n  }\n\n  const result = pugToJsx(source, {\n    template: true,\n    resolve,\n    transform,\n    pragma,\n    autoFix,\n    rootDir,\n    resourcePath,\n  });\n  const { jsxTemplate, usage, useThis, variables } = result;\n\n  if (options.autoUpdateJsFile) {\n    codemod({ useThis, variables }, this.resourcePath);\n  }\n\n  const basename = this.resourcePath.split(path.sep).pop().replace(/\\.[a-zA-Z0-9]+$/, '');\n  const code = jsxTemplate.replace(/%BASENAME%/g, `./${basename}`);\n\n  if (options.transpiledFile) {\n    const transpiledJsx = this.resourcePath.replace(/(\\.[a-zA-Z0-9]+)$/, '$1.transpiled.jsx');\n    const usageExample = ['/* USAGE EXAMPLE */',\n      usage.replace(/%BASENAME%/g, basename),\n      '/* // USAGE EXAMPLE */',\n    ].join('\\n').split('\\n').map(e => `//  ${e}`).join('\\n');\n    fs.writeFileSync(transpiledJsx, `${code}\\n\\n${usageExample}\\n`, 'utf8');\n  }\n\n  return options.detail ? { ...result, jsxTemplate: code } : code;\n}\n"],"names":["j","require","babylon","parser","parse","code","sourceType","allowImportExportEverywhere","allowReturnOutsideFunction","startLine","tokens","plugins","proposal","getSource","source","file","fileExt","split","pop","fs","path","glob","isTemplateWithThis","p","templateFuncs","node","callee","object","indexOf","name","property","isTemplateWithoutThis","compareVariables","a","b","nameA","key","replace","nameB","priorityA","search","priorityB","getLinkedJsFiles","files","linkedJsFiles","sync","join","filter","map","content","readFileSync","find","ImportDeclaration","nodes","e","specifiers","length","value","pug","local","codemod","useThis","variables","resourcePath","filePath","sep","printOptions","quote","trailingComma","jsFiles","forEach","commentRemoved","CallExpression","ce","templateFuncName","RegExp","whole","breadcrumbs","root","withThis","variableExists","componentExists","properties","arguments","pureName","comments","oldVars","objectProperty","identifier","sort","commentLine","type","jsxCode","toSource","trim","Math","random","toString","substr","literal","shorthand","memberExpression","thisExpression","objectExpression","result","Object","keys","reduce","prev","p1","p2","templateFunc","writeFileSync","err","console","error","loader","options","getOptions","transform","pragma","autoFix","rootDir","rootContext","resolve","resolveComponents","entries","moduleName","resolveVariables","match","useMacro","jsxTemplate","_p0","_p1","p3","jsx","macroFound","pugToJsx","template","p0","repeat","detail","usage","autoUpdateJsFile","basename","transpiledFile","transpiledJsx","usageExample"],"mappings":"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"}